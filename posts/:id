<!-- begin #page - the container for everything but header -->
<div id="page">
    <div class="container clearfix" id="main-content"> 
        <!--begin main content-->
        <div class="row-fluid sidebar-right"> 
            <div class="span2" id="blog_detail_container_1">
                <script id="blog_detail_template_1" type="x-tmpl-mustache">
                    <div id="postSocial">
                        <ul class="blogposts">
                            <li>
                                <span class="date"> 
                                    <span class="month">{{publish_date_month}}</span>
                                    <span class="day"><b>{{publish_date_day}}</b></span>
                                </span>
                            </li>
                        </ul>
                    </div>
                </script>
            </div>
            <div class="span7 blog-detail primary-column" id="blog_detail_container_2"> 
                <center><img alt="loading" style="width:100px; height:100px;" src="//codecloud.cdn.speedyrails.net/sites/5757295d6e6f647a06080000/image/gif/1488389451000/loading.gif"></center>
                <script id="blog_detail_template_2" type="x-tmpl-mustache">
                    <div class="blog-detail-nav">
                        {{#prev_post}}
                            <a class="prev-post" href="/posts/{{prev_slug}}">PREVIOUS STORY</a>
                        {{/prev_post}}
                        {{#next_post}}
                            <a class="next-post" href="/posts/{{next_slug}}">NEXT STORY</a>
                        {{/next_post}}
                    </div>
                    <article class="entry-post">
                        <header class="entry-header">
                            <div class="addthis_native_toolbox pull-right"></div>
                            {{#video_link}}
                                <div class="video-container" id="post_video">
                                    <iframe width="560" height="315" src="//www.youtube.com/embed/{{.}}" frameborder="0" allowfullscreen></iframe>
                                </div>
                            {{/video_link}}
                            {{#image_url}}
                                <div class="photo-container">
                                    <img src="{{.}}" />
                                </div>
                            {{/image_url}}
                            <h1>{{ title }}</h1>
                            <p class="author">By: {{author}}</p>
                            {{{ html_body }}}
                        </header>
                        <!--end entry-header-->
                        <div class="entry-tags">
                            <p>TAGS</p>
                            {{#tag}}
                                <a href="/categories/{{.}}" rel="tag">{{.}}</a><span> /</span>
                            {{/tag}}
                        </div>                  
                    </article>
                    <section id="view-comments" class="entry-comments clearfix">
                        <!-- DISQUS start -->
                        <div id="disqus_thread"></div>
                        <script type="text/javascript">
                            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                            var disqus_shortname = 'pickering'; // required: replace example with your forum shortname
                    
                            /* * * DON'T EDIT BELOW THIS LINE * * */
                            (function() {
                                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                            })();
                        </script>
                        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript"></a></noscript>
                        <a href="http://disqus.com" class="dsq-brlink"></span></a>
                        <!-- DISQUS end -->
                    </section>
                </script>
            </div>
            <section class="span3 sidebar secondary-column" id="secondary-nav">
                <aside class="widget">
                    <h5 class="short_headline"><span><b>LATEST</b> POSTS</span></h5>
                    <div class="sidebar-tabs" id="blog_detail_container_3"></div>
                        <script id="blog_detail_template_3" type="x-tmpl-mustache">
                            <div class="panels">
                                <div id="tab-latest">
                                    <ul class="blogposts clearfix">
                                        {{#.}}
                                            <li> 
                                                <span class="date"> 
                                                    <span class="month">{{publish_date_month}}</span> 
                                                    <span class="day" style="font-size:11.43px;"><b>{{publish_date_day}}</b></span> 
                                                </span>
                                                <h3><a href="/posts/{{slug}}" title="{{ title }}">{{ title }}</a></h3>
                                                <p></p>
                                            </li>
                                        {{/.}}
                                    </ul>
                                </div>
                            </div>
                        </script>
                </aside>
            </section>
        </div>
    </div>

    <!--<div class="row-fluid" id="blog_detail_container_4">-->
    <!--    <script id="blog_detail_template_4" type="x-tmpl-mustache">-->
    <!--        <div class="span10 offset1 entry-related">-->
    <!--            <h4 class="short_headline"><span><b>Related</b>Stories</span></h4>-->
    <!--            <div class="row-fluid equalHero equalHeights">-->
    <!--                {{#.}}-->
    <!--                <div class="span4 sparkNowTile">-->
    <!--                    <div class="sparkNowTileTop">-->
    <!--                        {{#tag_first}}-->
    <!--                            <a href="/posts/{{slug}}" class="sparkNowTileTag">{{.}}</a>-->
    <!--                        {{/tag_first}}-->
    <!--                        <a href="/posts/{{slug}}" class="sparkNowTileImg">-->
    <!--                            <img src="{{image_url}}" class="aligncenter" alt="" />-->
    <!--                        </a>-->
    <!--                    </div>-->
    <!--                    <div class="sparkNowTileTitle"><a href="/posts/{{slug}}"><h3>{{ title }}</h3></a></div>-->
    <!--                </div>-->
    <!--                {{/.}}-->
    <!--            </div>-->
    <!--        </div>-->
    <!--    </script>-->
    <!--</div>-->
</div>
<style>
    #blog_detail_container_1{
        margin-top:50px;
    }
    @media only screen and (max-width: 767px) {
        #blog_detail_container_1{
            display:none;
            
        }
        .blog-detail{
            border-right:none;
        }
    }
</style>

<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552bf365691d2c2d" async="async"></script>
<script>
    $(document).ready(function() {
        function renderPageData(){
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            var blog_detail = getPublishedPostDetailsBySlug(slug);
            // checkErrorPage(blog_detail);
           
            // var publish_date = new Date(blog_detail.publish_date);
            
            // var month_names_short = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
            // blog_detail.publish_date_month = month_names_short[publish_date.getMonth()]
            // blog_detail.publish_date_day = publish_date.getDate()

            
            // renderPostDetailTemplate('#blog_detail_template_1', '#blog_detail_container_1',blog_detail);
            renderPostDetails('#blog_detail_container_2', '#blog_detail_template_2', blog_detail);
            renderPostListTemplate('#blog_detail_template_3', '#blog_detail_container_3', getBlogDataBySlug('ptc-blog').posts);

        }
        
        loadMallData(renderPageData);
    });
    
    function renderPostDetailTemplate(blog_detail_template, blog_block, post){
    
        var item_list = [];
        var blog_template_html = $(blog_detail_template).html();
        Mustache.parse(blog_template_html);   // optional, speeds up future uses
        post.prev_post = getPrevPostBySlug(post.slug);
        post.next_post = getNextPostBySlug(post.slug);
    console.log(post)
        var blog_rendered = Mustache.render(blog_template_html,post);
        item_list.push(blog_rendered);
        $(blog_block).html(item_list.join(''));
    }
    
    function renderPostListTemplate(blog_template, blog_block, post){
        var item_list = [];
        var item_rendered = [];
        var blog_template_html = $(blog_template).html();
        Mustache.parse(blog_template_html);   // optional, speeds up future uses

        $.each( post, function( index, value ) {
            // MAX # IS 10
            if (index >= 10) {return false;};

            var publish_date = new Date(value.publish_date);
            
            var month_names_short = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
            value.publish_date_month = month_names_short[publish_date.getMonth()]
            value.publish_date_day = publish_date.getDate()

            item_list.push(value);
        });

        item_list.sort(function(a, b){
            if(a.publish_date > b.publish_date) return -1;
            if(a.publish_date < b.publish_date) return 1;
            return 0;
        });

        var blog_rendered = Mustache.render(blog_template_html,item_list);
        $(blog_block).html(blog_rendered);
    }

    function renderPostRelatedTemplate(blog_template, blog_block, posts, current_post){
        var item_list = [];
        var item_rendered = [];
        var blog_template_html = $(blog_template).html();
        Mustache.parse(blog_template_html);   // optional, speeds up future uses

        $.each( posts, function( index, value ) {
            // MAX # IS 3
            if (item_list.length >= 3) {return false;};

            if ($(value.tag).filter(current_post.tag).length > 0 && 
                value.id != current_post.id) {
                value.tag_first = value.tag[0];
                item_list.push(value);
            };
        });

        item_list.sort(function(a, b){
            if(a.publish_date > b.publish_date) return -1;
            if(a.publish_date < b.publish_date) return 1;
            return 0;
        });
        var blog_rendered = Mustache.render(blog_template_html,item_list);
        $(blog_block).html(blog_rendered);
    }
    
    function renderPostDetails(container, template, collection){
        var item_list = [];
        var item_rendered = [];
        var template_html = $(template).html();
        $.each( collection , function( key, val ) {
            if (val.image_url.indexOf('missing.png') > -1) {
                val.post_image = "http://assets.codecloudapp.com/sites/56056be06e6f641a1d020000/image/png/1446826281000/stc-logo-holiday-360 copy.png";
            } else {
                val.post_image = val.image_url;
            }
            if(val.body.length > 100){
                val.description_short = val.body.substring(0,100) + "...";
            }
            else{
                val.description_short = val.body;
            }
            var date_blog = new Date((val.publish_date + " 05:00:00").replace(/-/g,"/"));
            val.published_on = get_month(date_blog.getMonth()) + " " + date_blog.getDate() + ", " + date_blog.getFullYear();
            if (val.author == ""){
                val.author= " - ";
            }
            var next_p = getNextPublishedPostBySlug(val.slug);
            var prev_p = getPrevPublishedPostBySlug(val.slug);
            if (next_p == undefined){
                val.next_post_show = "display:none";
            }
            else{
                val.next_post = next_p.title;
                val.next_slug = next_p.slug;
                val.next_post_show = "display:inline-block";
            }
            if (prev_p == undefined){
                val.prev_post_show = "display:none";
            }
            else{
                val.prev_post = prev_p.title;
                val.prev_slug = prev_p.slug;
                val.prev_post_show = "display:inline-block";
            }
            
            if (val.tag != undefined){
                val.tag_list = val.tag.join(', ');
            }
            
            var rendered = Mustache.render(template_html,val);
            item_rendered.push(rendered);
        });
        console.log(item_rendered.join(''))
        $(container).html(item_rendered.join(''));
    }
    function get_month (id){
    var month = ""
    switch(id) {
        case 0:
            month = "Jan";
            break;
        case 1:
            month = "Feb";
            break;
        case 2:
            month = "Mar";
            break;
        case 3:
            month = "Apr";
            break;
        case 4:
            month = "May";
            break;
        case 5:
            month = "June";
            break;
        case 6:
            month = "July";
            break;
        case 7:
            month = "Aug";
            break;
        case 8:
            month = "Sep";
            break;
        case 9:
            month = "Oct";
            break;
        case 10:
            month = "Nov";
            break;
        case 11:
            month = "Dec";
            break;
            
    }
    return month;
}
</script>    